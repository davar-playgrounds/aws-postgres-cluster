# aws-postgres-cluster

## Requirements for execution

This project was tested using a ubuntu 18.04 as workstation/desktop

### Download

```text
dyego@ubuntu:~$ wget https://github.com/dyegoe/aws-postgres-cluster/archive/master.zip
dyego@dyego:~$ unzip master.zip
Archive:  master.zip
11eb73987e1b8f02899a2e820b06aa6e3ffc3cff
   creating: aws-postgres-cluster-master/
  inflating: aws-postgres-cluster-master/.gitignore  
...
dyego@dyego:~$ cd aws-postgres-cluster-master/
```

### Inventory

You **must** keep the `inventories/inventory.conf` as default.

### Group Vars

Inside the `group_vars/` directory, you can find an example file. You must copy/move/rename it to `all.yml` after run the playbook. Further, you must configure vars there **before** run playbook.

```yaml
---
aws_access_key: put-here-your-access-key
aws_secret_key: put-here-your-secret-key
region: us-east-1
project_name: aws-pg-cls
vpc_cidr: 10.10.0.0/16
subnet1_cidr: 10.10.0.0/24
subnet2_cidr: 10.10.1.0/24
db_username: postgres
db_password: password
db_name: pgcls
email_host: smtp.mailtrap.io
email_host_user: user
email_host_password: password
email_port: 2525
email_default_sender: blacklist@domain.test
```

### Terraform

You must have `terraform` in your computer. [Download it](https://www.terraform.io/downloads.html)

### Python virtual env

```text
dyego@ubuntu:~/aws-postgres-cluster-master$ sudo apt install python-pip python-virtualenv
dyego@ubuntu:~/aws-postgres-cluster-master$ virtualenv -p /usr/bin/python3 ~/python3-ansible
dyego@ubuntu:~/aws-postgres-cluster-master$ source ~/python3-ansible/bin/activate
(python3-ansible) dyego@ubuntu:~/aws-postgres-cluster-master$ pip install ansible
```

### To run the playbook

```text
(python3-ansible) dyego@dyego:~/aws-postgres-cluster-master$ ansible-playbook -i inventories/inventory.conf playbook.yml
```

After playbook finish, you can page-up and check this output if you would like to connect on the server.

```text
TASK [run_terraform : Add EC2 instances to the inventory in runtime] ***********************************************************************************
changed: [localhost] => (item={'hostname': '52.90.200.42', 'private_ip': '10.10.0.140', 'groups': 'app'})
changed: [localhost] => (item={'hostname': '52.91.48.17', 'private_ip': '10.10.0.238', 'groups': 'db-master'})
changed: [localhost] => (item={'hostname': '34.227.71.111', 'private_ip': '10.10.1.73', 'groups': 'db-slave'})
```

To access those server, you should use the private key generated by the playbook.

```text
(python3-ansible) dyego@ubuntu:~/aws-postgres-cluster-master$ ssh -i files/id_rsa admin@52.90.200.42
```

### To destroy

```text
(python3-ansible) dyego@dyego:~/aws-postgres-cluster-master$ ansible-playbook -i inventories/inventory.conf destroy.yml
```

## Coverage

- Create a pair of ssh keys.
- Apply a terraform infrastructure and create a temporary inventory with the terraform outputs.
- Update linux and install required packages: docker, docker-compose.
- Deploy docker-compose on each server.
- Deploy a php that show a Fibonacci series. http://_host_/?n=10
- Deploy a python that block the IP which requested the url http://_host_/blacklisted than send an email.
- Configure postgresql as a master/slave replication.

## Know issues

- Terraform aws_ami data source [doesn't cache the AMI id](https://github.com/hashicorp/terraform/issues/13749). It does each time terraform recreates the aws_instance resource. To avoid that, I fixed the AMI id on terraform. I kept the reference commented on the terraform file.

## Improvements

- This playbook covers only Debian distribution, using module apt only, for example. It should be improved to cover other distributions.
- Avoid to include more than one master on `roles/pre_config_db/templates/*-pg_hba.conf.j2`, `roles/pre_config_db_slave/templates/recovery.conf.j2` and `roles/pre_config_db_slave/tasks/main.yml`.
- Include on terraform to change the rule 100 on default acl to a bigger number, because now we can have only 99 blacklisted IPs.

## References

- [Terraform - aws_security_group](https://www.terraform.io/docs/providers/aws/r/security_group.html)
- [Terraform - Data Source: aws_ami](https://www.terraform.io/docs/providers/aws/d/ami.html)
- [Terraform - Fix a wrong parameter which forces a instance recreation](https://github.com/hashicorp/terraform/issues/13749)
- [Ansible - Manages a Terraform deployment (and plans)](https://docs.ansible.com/ansible/devel/modules/terraform_module.html)
- [Postgres - Master/Slave](https://blog.raveland.org/post/postgresql_sr/)
- [Python - Flask + SQLAlchemy](http://blog.sahildiwan.com/posts/flask-and-postgresql-app-deployed-on-heroku/)
- [Python - Flask-Boto3](https://github.com/Ketouem/flask-boto3)
- [Python - Flask-Mail](https://pythonhosted.org/Flask-Mail/)